<!DOCTYPE html>
<html lang="es-MX">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Ciudad Futura: El Arquitecto de la Equidad</title>
<!--
  VERSIÃ“N FINAL
  - MÃºsica de fondo: ELIMINADA.
  - Audio: Solo Voz (TTS) y efectos de clic suaves.
  - UI: Optimizada para niÃ±os 6-10 aÃ±os.
-->
<style>
  :root{
    --bg: #e0f2fe;
    --panel: #ffffff;
    --text: #0f172a;
    --accent: #0ea5e9;       /* Azul brillante */
    --accent-hover: #0284c7;
    --accent-2: #f59e0b;     /* Naranja */
    --accent-3: #22c55e;     /* Verde Ã©xito */
    --danger: #ef4444;       /* Rojo alerta */
    --shadow: 0 8px 16px rgba(0,0,0,.1);
    --radius: 20px;
    --font-main: system-ui, -apple-system, sans-serif;
  }
  
  /* Modos de accesibilidad */
  body.high-contrast{ --bg:#000; --panel:#111; --text:#fff; --accent:#fbbf24; --accent-2:#f472b6; --accent-3:#4ade80; }
  
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body{ margin:0; background:var(--bg); color:var(--text); font-family: var(--font-main); overflow-x: hidden; }
  
  .app{ max-width: 1024px; margin: 0 auto; padding: 10px; min-height: 100vh; display:flex; flex-direction:column; }

  /* TipografÃ­a */
  h1{ font-size: clamp(1.8rem, 4vw, 2.5rem); line-height: 1.1; margin-bottom:10px; }
  h2{ font-size: 1.5rem; margin-bottom: 0.5rem; margin-top:0; }
  p { font-size: 1.1rem; line-height: 1.5; max-width: 65ch; margin-top:0; }
  
  /* Tarjetas */
  .card{ background:var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px; transition: all .3s; }
  .scene{ display:none; animation: fadeIn .5s ease; flex:1; }
  .scene.active{ display:block; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

  /* Botones */
  .btn{
    background: var(--accent); color: white; border:none; padding: 12px 24px;
    font-size: 1.2rem; font-weight: 700; border-radius: 16px;
    cursor: pointer; box-shadow: 0 6px 0 var(--accent-hover);
    transition: transform .1s; display:inline-flex; align-items:center; gap:8px;
    min-height: 56px; touch-action: manipulation;
  }
  .btn:active{ transform: translateY(4px); box-shadow: 0 2px 0 var(--accent-hover); }
  .btn.secondary{ background: var(--accent-2); box-shadow: 0 6px 0 #d97706; color:#333; }
  .btn.secondary:active{ box-shadow: 0 2px 0 #d97706; }
  .btn.ghost{ background: transparent; border: 2px solid var(--text); color: var(--text); box-shadow:none; }
  .btn.circle{ border-radius: 50%; width: 56px; padding:0; justify-content:center; }

  /* UI Grid */
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .space{ height: 20px; }
  .grid-layout{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
  @media(max-width:768px){ .grid-layout{ grid-template-columns:1fr; } }

  /* INICIO */
  .hero-img{ font-size: 80px; text-align:center; animation: float 3s infinite ease-in-out; }
  @keyframes float{ 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }
  
  /* Botones Accesibilidad */
  .access-bar{ display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; margin-top:20px; justify-content:center; }
  .toggle-btn{
    background: rgba(0,0,0,0.05); padding: 8px 16px; border-radius: 30px; font-weight:bold; cursor:pointer; font-size:0.9rem; border:2px solid transparent; white-space:nowrap;
  }
  .toggle-btn.active{ background: var(--accent-3); color: #003300; border-color: var(--text); }

  /* BRIEFING */
  .avatar-box{ display:flex; flex-direction:column; align-items:center; text-align:center; }
  .avatar{ font-size: 80px; background: #fecdd3; width:120px; height:120px; border-radius:50%; display:flex; align-items:center; justify-content:center; border: 4px solid white; box-shadow: var(--shadow); margin-bottom:10px; }
  .speech-bubble{
    background: var(--panel); border: 3px solid var(--accent); border-radius: 20px; padding: 20px; font-size: 1.3rem; position:relative; min-height: 120px; display:flex; align-items:center; justify-content:center; text-align:center; font-weight: 500;
  }
  
  /* MISIÃ“N UI */
  .top-bar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .meters{ display:flex; gap:15px; flex:1; }
  .meter-box{ background: white; padding: 8px 12px; border-radius: 12px; box-shadow: 0 4px rgba(0,0,0,0.1); flex:1; max-width:200px; }
  .meter-label{ font-size: 0.85rem; font-weight:bold; color:#64748b; margin-bottom:4px; }
  .progress-bg{ height: 12px; background: #e2e8f0; border-radius: 10px; overflow:hidden; }
  .progress-fill{ height: 100%; background: var(--accent-3); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
  
  .game-area{ display:grid; grid-template-columns: 300px 1fr; gap:20px; align-items:start; }
  @media(max-width:900px){ .game-area{ grid-template-columns:1fr; } .game-area > :first-child{ order:2; } }

  /* Paleta */
  .building-list{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .b-card{
    display:flex; align-items:center; gap:15px; padding: 12px; border-radius: 16px; background:white; cursor:pointer; border: 3px solid transparent; transition: all .2s;
  }
  .b-card:hover{ transform: scale(1.02); }
  .b-card.selected{ border-color: var(--accent); background: #e0f2fe; }
  .b-card.done{ opacity: 0.6; filter: grayscale(0.8); pointer-events:none; }
  .b-icon{ font-size: 2.5rem; line-height:1; }
  .b-info{ display:flex; flex-direction:column; }
  .b-name{ font-weight:800; font-size:1.1rem; }
  .b-status{ font-size:0.8rem; font-weight:bold; color:var(--accent); }

  /* Mapa */
  .map-container{ background: #94a3b8; padding:15px; border-radius: 20px; box-shadow: inset 0 4px 10px rgba(0,0,0,0.2); overflow-x:auto; }
  .map-grid{
    display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; min-width: 600px;
  }
  .tile{
    aspect-ratio: 1; background: #e2e8f0; border-radius: 12px; border: none; cursor:pointer; position:relative; transition: all .2s; outline:none; box-shadow: 0 4px 0 #94a3b8;
  }
  .tile:active{ transform:translateY(4px); box-shadow:none; }
  .tile:focus-visible{ box-shadow: 0 0 0 4px var(--accent-2); }
  
  .tile.empty:hover{ background: #f1f5f9; }
  .tile.placed{ background: #bfdbfe; border: 3px dashed var(--accent); }
  .tile.complete{ background: #bbf7d0; border: 3px solid var(--accent-3); box-shadow: 0 0 15px var(--accent-3); }
  .tile-content{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size: 2.5rem; pointer-events:none; }
  .tile-badge{
    position:absolute; top:-5px; right:-5px; width:24px; height:24px; background:var(--danger); color:white; font-size:14px; font-weight:bold; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: pulse 1s infinite;
  }
  @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

  /* PUZZLE MODAL */
  .modal-overlay{
    position:fixed; inset:0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index:100; display:none; align-items:center; justify-content:center; padding:10px;
  }
  .modal-overlay.open{ display:flex; }
  .modal-window{
    background: var(--panel); width: 100%; max-width: 900px; max-height: 90vh; overflow-y:auto; border-radius: 24px; padding: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popIn .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes popIn{ from{transform:scale(0.8); opacity:0;} to{transform:scale(1); opacity:1;} }

  .puzzle-header{ display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom:15px; margin-bottom:15px; }
  .citizen-panel{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-bottom: 20px; }
  
  .cit-card{
    background: #f8fafc; padding: 12px; border-radius: 12px; display:flex; align-items:center; gap:12px; border-left: 6px solid #ccc; transition: all .3s;
  }
  .cit-card.sad{ border-left-color: var(--danger); background: #fef2f2; }
  .cit-card.happy{ border-left-color: var(--accent-3); background: #f0fdf4; transform: scale(1.02); }
  .cit-emoji{ font-size: 2.2rem; }
  
  .improvements-list{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px; }
  .imp-btn{
    background: white; border: 2px solid #cbd5e1; padding: 15px; border-radius: 16px; text-align:left; cursor:pointer; display:flex; align-items:center; gap:10px; font-weight:bold; transition:all .2s;
  }
  .imp-btn:hover{ border-color: var(--accent); background: #f0f9ff; }
  .imp-btn.active{ background: var(--accent); color:white; border-color:var(--accent); box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); }
  .imp-check{ width:24px; height:24px; border:2px solid currentColor; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:16px; }

  /* SubtÃ­tulos */
  .captions-box{
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 30px;
    font-size: 1.2rem; text-align:center; z-index: 200; pointer-events:none; max-width: 90%;
    opacity:0; transition: opacity .3s;
  }
  .captions-box.visible{ opacity:1; }

  #confetti{ position:fixed; inset:0; pointer-events:none; z-index:150; }
  .hidden{ display:none !important; }
</style>
</head>
<body>

<div class="app">

  <!-- ================= PANTALLA 1: INICIO ================= -->
  <section id="scene-intro" class="scene active">
    <div style="height:40px"></div>
    <div class="card" style="text-align:center; padding: 40px 20px;">
      <div class="hero-img">ğŸ™ï¸âœ¨</div>
      <h1>Ciudad Futura:<br>El Arquitecto de la Equidad</h1>
      <p style="margin:0 auto;">Â¡Hola! Tu misiÃ³n es construir una ciudad donde <b>todas y todos</b> puedan ser felices. Â¿EstÃ¡s listo?</p>
      
      <div class="space"></div>
      
      <button class="btn" onclick="game.startBriefing()">ğŸ® Â¡Empezar a Jugar!</button>
      <div class="space"></div>
      <button class="btn secondary" onclick="UI.toggleModal('modal-howto')">â“ Â¿CÃ³mo se juega?</button>
      
      <div class="space"></div>
      <hr style="border:0; border-top:1px solid #ddd; margin: 20px 0;">
      
      <p style="font-size:0.9rem"><b>Opciones de Accesibilidad:</b></p>
      <div class="access-bar">
        <button class="toggle-btn active" id="btn-voice" onclick="AudioSys.toggleVoice()">ğŸ—£ï¸ Voz SÃ­</button>
        <button class="toggle-btn" id="btn-contrast" onclick="UI.toggleContrast()">ğŸŒ— Alto Contraste</button>
      </div>
    </div>
  </section>

  <!-- ================= PANTALLA 2: BRIEFING (HISTORIA) ================= -->
  <section id="scene-briefing" class="scene">
    <div class="grid-layout" style="align-items:center; height:100%">
      <div class="avatar-box">
        <div class="avatar">ğŸ‘©â€ğŸ’¼</div>
        <div style="font-weight:bold; font-size:1.2rem">Consejera Ana</div>
      </div>
      <div>
        <div class="speech-bubble" id="briefing-text">
          <!-- Texto dinÃ¡mico -->
        </div>
        <div class="space"></div>
        <div class="row" style="justify-content: flex-end;">
          <button class="btn secondary" id="briefing-next" onclick="game.nextBriefingStep()">Siguiente â¡ï¸</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= PANTALLA 3: JUEGO (MISIÃ“N) ================= -->
  <section id="scene-game" class="scene">
    <!-- Barra Superior HUD -->
    <div class="top-bar">
      <div class="meters">
        <div class="meter-box">
          <div class="meter-label">ğŸ˜Š Felicidad Ciudadana</div>
          <div class="progress-bg"><div class="progress-fill" id="bar-happy" style="width:50%"></div></div>
        </div>
        <div class="meter-box">
          <div class="meter-label">ğŸ—ï¸ Edificios Listos</div>
          <div style="font-weight:bold; font-size:1.1rem" id="count-builds">0 / 5</div>
        </div>
      </div>
      <!-- BotÃ³n MenÃº -->
      <button class="btn circle ghost" onclick="UI.toggleMenu()" aria-label="MenÃº">âš™ï¸</button>
    </div>

    <!-- MenÃº desplegable -->
    <div id="game-menu" class="card hidden" style="position:absolute; right:10px; top:70px; z-index:50; width:200px;">
      <p><b>Ajustes</b></p>
      <button class="btn ghost small" style="width:100%" onclick="game.restart()">ğŸ”„ Reiniciar</button>
    </div>

    <div class="game-area">
      <!-- Izquierda: Paleta -->
      <div class="card">
        <h2>ğŸ› ï¸ Â¿QuÃ© construimos?</h2>
        <p style="font-size:0.9rem">Elige un edificio y colÃ³calo en el mapa.</p>
        <div class="building-list" id="building-palette">
          <!-- Se llena con JS -->
        </div>
      </div>

      <!-- Derecha: Mapa -->
      <div class="card" style="background: #f0f9ff;">
        <h2>ğŸ—ºï¸ Mapa de Ciudad Futura</h2>
        <div class="map-container">
          <div class="map-grid" id="map-grid">
            <!-- Tiles generados por JS -->
          </div>
        </div>
        <div class="space"></div>
        <div style="background:#e0f2fe; padding:10px; border-radius:10px; font-size:0.9rem; display:flex; gap:10px; align-items:center;">
          <span>â„¹ï¸ <b>Ayuda:</b> Haz clic en un edificio colocado para mejorarlo con IA.</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= PANTALLA 4: RESULTADO ================= -->
  <section id="scene-result" class="scene">
    <div class="card" style="text-align:center; padding:40px;">
      <div id="result-icon" style="font-size:100px;">ğŸ†</div>
      <h1 id="result-title">Â¡FantÃ¡stico!</h1>
      <p id="result-msg" style="font-size:1.3rem;">Has creado una ciudad donde todos caben.</p>
      <div class="space"></div>
      <button class="btn" onclick="game.restart()">ğŸ”„ Jugar otra vez</button>
    </div>
  </section>

</div>

<!-- MODAL: CÃ“MO JUGAR -->
<div class="modal-overlay" id="modal-howto">
  <div class="modal-window" style="max-width:500px;">
    <h2>â“ CÃ³mo se juega</h2>
    <ol style="font-size:1.1rem; line-height:1.6; padding-left:20px;">
      <li><b>Elige un edificio</b> del menÃº de la izquierda.</li>
      <li><b>ColÃ³calo</b> en un cuadro gris del mapa.</li>
      <li><b>Â¡IMPORTANTE!</b> El edificio empieza "bÃ¡sico". Haz clic en Ã©l otra vez para abrir el <b>Puzzle de DiseÃ±o</b>.</li>
      <li>Agrega rampas, braille y ayudas para subir la felicidad ğŸ˜Š.</li>
      <li>Completa 5 edificios para ganar.</li>
    </ol>
    <div style="text-align:right"><button class="btn" onclick="UI.toggleModal('modal-howto')">Â¡Entendido!</button></div>
  </div>
</div>

<!-- MODAL: PUZZLE DE DISEÃ‘O -->
<div class="modal-overlay" id="modal-puzzle">
  <div class="modal-window">
    <div class="puzzle-header">
      <h2 id="pz-title" style="margin:0">ğŸ¥ Hospital</h2>
      <button class="btn ghost circle" onclick="UI.closePuzzle()">âœ–</button>
    </div>

    <div class="grid-layout">
      <!-- Columna 1: Ciudadanos -->
      <div>
        <h3>ğŸ‘¥ Â¿QuiÃ©nes lo usan?</h3>
        <p style="font-size:0.9rem">Observa quiÃ©nes estÃ¡n tristes y dales lo que necesitan.</p>
        <div class="citizen-panel" id="pz-citizens"></div>
      </div>

      <!-- Columna 2: Mejoras -->
      <div>
        <h3>âœ¨ Mejoras de InclusiÃ³n (IA)</h3>
        <p style="font-size:0.9rem">Selecciona las herramientas para eliminar barreras:</p>
        <div class="improvements-list" id="pz-improvements"></div>
        
        <div class="space"></div>
        <hr>
        <div class="row" style="justify-content:space-between; margin-top:15px;">
          <div style="font-size:0.9rem; color:#666">Objetivo: Haz felices a todos</div>
          <button class="btn" id="pz-btn-finish" onclick="game.finishPuzzle()">âœ… Â¡DiseÃ±o Listo!</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SubtÃ­tulos flotantes -->
<div class="captions-box" id="captions"></div>
<canvas id="confetti"></canvas>

<script>
/* =========================================
   SISTEMA DE AUDIO: SOLO VOZ Y SFX SIMPLES
   ========================================= */
const AudioSys = {
  ctx: null,
  voiceEnabled: true,

  init: function() {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    this.ctx = new AudioContext();
  },

  toggleVoice: function(){
    this.voiceEnabled = !this.voiceEnabled;
    const btn = document.getElementById('btn-voice');
    btn.className = this.voiceEnabled ? 'toggle-btn active' : 'toggle-btn';
    btn.textContent = this.voiceEnabled ? "ğŸ—£ï¸ Voz SÃ­" : "ğŸ—£ï¸ Voz No";
    if(!this.voiceEnabled) window.speechSynthesis.cancel();
  },

  sfx: function(type) {
    // Genera un sonido muy corto y suave (click/pop) solo para feedback tÃ¡ctil
    if(!this.ctx) this.init();
    if(this.ctx.state === 'suspended') this.ctx.resume();

    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.connect(g); g.connect(this.ctx.destination);

    const t = this.ctx.currentTime;
    
    if(type === 'pop') {
      // Sonido de clic suave
      o.frequency.setValueAtTime(300, t);
      o.frequency.exponentialRampToValueAtTime(600, t + 0.1);
      g.gain.setValueAtTime(0.2, t);
      g.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
      o.start(t); o.stop(t + 0.1);
    } else if(type === 'success') {
      // Sonido de Ã©xito corto (campanita)
      o.type = 'triangle';
      o.frequency.setValueAtTime(500, t);
      o.frequency.setValueAtTime(800, t + 0.1);
      g.gain.setValueAtTime(0.2, t);
      g.gain.linearRampToValueAtTime(0, t + 0.4);
      o.start(t); o.stop(t + 0.4);
    }
  },

  speak: function(text) {
    // Visual: SubtÃ­tulos
    const cap = document.getElementById('captions');
    cap.textContent = text;
    cap.classList.add('visible');
    clearTimeout(this.capTimer);
    this.capTimer = setTimeout(()=>cap.classList.remove('visible'), Math.max(3000, text.length * 80));

    // Audio: TTS
    if(!this.voiceEnabled) return;
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'es-MX'; u.rate = 1.1;
    window.speechSynthesis.speak(u);
  }
};

/* =========================================
   DATOS DEL JUEGO
   ========================================= */
const DB = {
  citizens: [
    {id:'gma', name:'Abuela Luisa', icon:'ğŸ‘µ', needs:['motor','visual'], desc:'Usa bastÃ³n y ve poco.'},
    {id:'kid', name:'Leo', icon:'ğŸ§’', needs:['kids'], desc:'Es pequeÃ±o.'},
    {id:'wheel', name:'Ana', icon:'ğŸ‘§â™¿', needs:['motor'], desc:'Usa silla de ruedas.'},
    {id:'migrant', name:'Familia Khan', icon:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§', needs:['lang'], desc:'Hablan otro idioma.'}
  ],
  buildings: [
    {
      id: 'park', name: 'Parque', icon: 'ğŸŒ³',
      barriers: ['motor', 'kids'],
      upgrades: [
        {id:'ramps', text:'Rampas de acceso', covers:['motor']},
        {id:'swings', text:'Columpios adaptados', covers:['motor','kids']},
        {id:'floor', text:'Suelo de goma suave', covers:['kids']}
      ]
    },
    {
      id: 'bus', name: 'EstaciÃ³n Bus', icon: 'ğŸšŒ',
      barriers: ['visual', 'lang'],
      upgrades: [
        {id:'audio', text:'MegafonÃ­a (Audio)', covers:['visual']},
        {id:'signs', text:'SeÃ±ales Multi-idioma', covers:['lang']},
        {id:'braille', text:'Mapas con Braille', covers:['visual']}
      ]
    },
    {
      id: 'hospital', name: 'Hospital', icon: 'ğŸ¥',
      barriers: ['motor', 'visual', 'lang'],
      upgrades: [
        {id:'elev', text:'Ascensor amplio', covers:['motor']},
        {id:'guide', text:'GuÃ­as en el suelo', covers:['visual']},
        {id:'pics', text:'Pictogramas (Dibujos)', covers:['lang','kids']}
      ]
    },
    {
      id: 'school', name: 'Escuela', icon: 'ğŸ«',
      barriers: ['motor', 'kids'],
      upgrades: [
        {id:'ramp', text:'Rampa en entrada', covers:['motor']},
        {id:'desk', text:'Pupitres ajustables', covers:['motor','kids']}
      ]
    },
    {
      id: 'lib', name: 'Biblioteca', icon: 'ğŸ“š',
      barriers: ['visual', 'lang'],
      upgrades: [
        {id:'audiobooks', text:'Audiolibros', covers:['visual']},
        {id:'trans', text:'Libros en varios idiomas', covers:['lang']}
      ]
    }
  ]
};

/* =========================================
   LÃ“GICA DE JUEGO
   ========================================= */
const game = {
  state: {
    felicity: 30,
    completed: 0,
    grid: Array(16).fill(null),
    selectedBuilding: null,
    buildingsPlaced: []
  },

  init: function() {
    this.renderPalette();
    this.renderGrid();
    UI.updateHUD();
  },

  restart: function() {
    this.state = { felicity: 30, completed: 0, grid: Array(16).fill(null), selectedBuilding: null, buildingsPlaced: [] };
    document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
    document.getElementById('scene-intro').classList.add('active');
    document.getElementById('game-menu').classList.add('hidden');
    UI.updateHUD();
    this.renderGrid();
    this.renderPalette();
  },

  // --- BRIEFING ---
  briefStep: 0,
  briefTexts: [
    "Â¡Hola, Arquitecto! ğŸ‘·â€â™€ï¸ Soy tu consejera Ana.",
    "Mira este terreno. Queremos construir una ciudad genial.",
    "Pero ojo: una IA bÃ¡sica a veces olvida que todos somos diferentes.",
    "Tu trabajo es corregir a la IA y poner mejoras para todos. Â¿Listo?"
  ],

  startBriefing: function() {
    UI.showScene('scene-briefing');
    this.briefStep = 0;
    this.showBriefText();
  },

  nextBriefingStep: function() {
    this.briefStep++;
    if(this.briefStep >= this.briefTexts.length){
      UI.showScene('scene-game');
      this.init();
      AudioSys.speak("Selecciona un edificio de la izquierda para empezar.");
    } else {
      this.showBriefText();
    }
  },

  showBriefText: function() {
    const txt = this.briefTexts[this.briefStep];
    document.getElementById('briefing-text').textContent = txt;
    AudioSys.speak(txt);
  },

  // --- MAPA Y CONSTRUCCIÃ“N ---
  renderPalette: function() {
    const p = document.getElementById('building-palette');
    p.innerHTML = '';
    DB.buildings.forEach(b => {
      const placed = this.state.buildingsPlaced.find(pb => pb.typeId === b.id);
      const div = document.createElement('div');
      div.className = `b-card ${placed ? (placed.isComplete ? 'done' : '') : ''}`;
      if(this.state.selectedBuilding === b.id) div.classList.add('selected');
      
      div.innerHTML = `
        <div class="b-icon">${b.icon}</div>
        <div class="b-info">
          <div class="b-name">${b.name}</div>
          <div class="b-status">${placed ? (placed.isComplete ? 'âœ… Listo' : 'âš ï¸ Falta mejorar') : 'ğŸ†• Nuevo'}</div>
        </div>
      `;
      div.onclick = () => {
        if(placed && placed.isComplete) return;
        this.selectBuilding(b.id); 
      };
      p.appendChild(div);
    });
  },

  selectBuilding: function(id) {
    this.state.selectedBuilding = id;
    AudioSys.sfx('pop');
    AudioSys.speak("Ahora toca un cuadro gris en el mapa.");
    this.renderPalette();
  },

  renderGrid: function() {
    const g = document.getElementById('map-grid');
    g.innerHTML = '';
    this.state.grid.forEach((cell, idx) => {
      const btn = document.createElement('button');
      btn.className = 'tile empty';
      
      if(cell) {
        btn.classList.remove('empty');
        btn.classList.add('placed');
        if(cell.isComplete) btn.classList.add('complete');
        
        let content = `<div class="tile-content">${cell.data.icon}</div>`;
        if(!cell.isComplete) content += `<div class="tile-badge">!</div>`;
        btn.innerHTML = content;
        
        btn.onclick = () => this.openPuzzle(cell);
      } else {
        btn.onclick = () => this.placeBuilding(idx);
      }
      g.appendChild(btn);
    });
  },

  placeBuilding: function(idx) {
    if(!this.state.selectedBuilding) {
      AudioSys.speak("Primero elige un edificio del menÃº izquierdo.");
      return;
    }
    if(this.state.buildingsPlaced.find(b => b.typeId === this.state.selectedBuilding)) {
      AudioSys.speak("Ya construiste este edificio. Â¡MejÃ³ralo!");
      return;
    }

    const bData = DB.buildings.find(b => b.id === this.state.selectedBuilding);
    const newBuild = {
      id: Date.now(),
      typeId: bData.id,
      data: bData,
      upgradesApplied: [],
      isComplete: false
    };

    this.state.grid[idx] = newBuild;
    this.state.buildingsPlaced.push(newBuild);
    this.state.selectedBuilding = null;
    
    AudioSys.sfx('pop');
    AudioSys.speak("Â¡Bien! Ahora tÃ³calo para hacerlo inclusivo.");
    
    this.renderGrid();
    this.renderPalette();
    
    setTimeout(() => this.openPuzzle(newBuild), 600);
  },

  // --- PUZZLE ---
  currentPuzzle: null,

  openPuzzle: function(buildObj) {
    this.currentPuzzle = buildObj;
    const modal = document.getElementById('modal-puzzle');
    document.getElementById('pz-title').innerText = `${buildObj.data.icon} ${buildObj.data.name}`;
    this.renderPuzzleState();
    UI.toggleModal('modal-puzzle', true);
    if(!buildObj.isComplete) {
      AudioSys.speak("Mira a los ciudadanos tristes. Â¿QuÃ© necesitan?");
    }
  },

  renderPuzzleState: function() {
    const build = this.currentPuzzle;
    const bData = build.data;
    
    // 1. Ciudadanos
    const cPanel = document.getElementById('pz-citizens');
    cPanel.innerHTML = '';
    let allHappy = true;
    
    DB.citizens.forEach(cit => {
      const hasBarrier = bData.barriers.some(br => cit.needs.includes(br));
      let isHappy = true;
      if(hasBarrier) {
        const coveredNeeds = new Set();
        build.upgradesApplied.forEach(upId => {
          const up = bData.upgrades.find(u=>u.id===upId);
          if(up) up.covers.forEach(c => coveredNeeds.add(c));
        });
        if(cit.needs.some(n => bData.barriers.includes(n) && !coveredNeeds.has(n))) isHappy = false;
      }
      if(!isHappy) allHappy = false;

      const card = document.createElement('div');
      card.className = `cit-card ${isHappy ? 'happy' : 'sad'}`;
      card.innerHTML = `
        <div class="cit-emoji">${isHappy ? 'ğŸ˜ƒ' : 'ğŸ˜Ÿ'}</div>
        <div class="cit-text">
          <b>${cit.name} ${cit.icon}</b>
          <small>${isHappy ? 'Â¡Puede entrar!' : 'Tiene problemas'}</small>
        </div>
      `;
      cPanel.appendChild(card);
    });

    // 2. Mejoras
    const iPanel = document.getElementById('pz-improvements');
    iPanel.innerHTML = '';
    bData.upgrades.forEach(up => {
      const isActive = build.upgradesApplied.includes(up.id);
      const btn = document.createElement('button');
      btn.className = `imp-btn ${isActive ? 'active' : ''}`;
      btn.innerHTML = `<div class="imp-check">${isActive ? 'âœ“' : ''}</div><span>${up.text}</span>`;
      btn.onclick = () => this.toggleUpgrade(up.id);
      iPanel.appendChild(btn);
    });

    // BotÃ³n terminar
    const btnFin = document.getElementById('pz-btn-finish');
    if(allHappy) {
      btnFin.style.display = 'inline-flex';
      btnFin.className = 'btn';
      btnFin.innerHTML = "âœ… Â¡Excelente! Terminar";
    } else {
      btnFin.style.display = 'none';
    }
  },

  toggleUpgrade: function(upId) {
    const build = this.currentPuzzle;
    const idx = build.upgradesApplied.indexOf(upId);
    if(idx > -1) {
      build.upgradesApplied.splice(idx, 1);
      AudioSys.sfx('pop');
    } else {
      build.upgradesApplied.push(upId);
      AudioSys.sfx('success');
    }
    this.renderPuzzleState();
  },

  finishPuzzle: function() {
    const build = this.currentPuzzle;
    if(!build.isComplete) {
      this.state.completed++;
      this.state.felicity += 15;
      build.isComplete = true;
      AudioSys.speak("Â¡FantÃ¡stico! Has eliminado las barreras.");
      this.confettiEffect();
    }
    UI.toggleModal('modal-puzzle', false);
    UI.updateHUD();
    this.renderGrid();
    this.renderPalette();
    this.checkVictory();
  },

  checkVictory: function() {
    if(this.state.completed >= 5) {
      setTimeout(() => {
        UI.showScene('scene-result');
        AudioSys.speak("Â¡Lo lograste! Eres un arquitecto de la equidad.");
        this.confettiEffect();
      }, 1000);
    }
  },
  
  confettiEffect: function() {
    const canvas = document.getElementById('confetti');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particles = [];
    for(let i=0; i<100; i++) {
      particles.push({
        x: canvas.width/2, y: canvas.height/2,
        vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
        color: `hsl(${Math.random()*360}, 100%, 50%)`
      });
    }
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.vy += 0.2;
        ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 8, 8);
        if(p.y > canvas.height) particles.splice(i, 1);
      });
      if(particles.length > 0) requestAnimationFrame(draw);
    }
    draw();
  }
};

const UI = {
  showScene: function(id) {
    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
  },
  toggleModal: function(id, forceOpen) {
    const el = document.getElementById(id);
    if(forceOpen !== undefined) {
      if(forceOpen) el.classList.add('open'); else el.classList.remove('open');
    } else {
      el.classList.toggle('open');
    }
  },
  closePuzzle: function() { this.toggleModal('modal-puzzle', false); },
  toggleContrast: function() {
    document.body.classList.toggle('high-contrast');
    const btn = document.getElementById('btn-contrast');
    btn.classList.toggle('active');
  },
  toggleMenu: function() { document.getElementById('game-menu').classList.toggle('hidden'); },
  updateHUD: function() {
    const bar = document.getElementById('bar-happy');
    const val = Math.min(100, game.state.felicity);
    bar.style.width = val + '%';
    if(val > 60) bar.style.background = 'var(--accent-3)'; else bar.style.background = 'var(--accent-2)';
    document.getElementById('count-builds').innerText = `${game.state.completed} / 5`;
  }
};

window.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') { UI.closePuzzle(); UI.toggleModal('modal-howto', false); }
});
</script>
</body>
</html>
