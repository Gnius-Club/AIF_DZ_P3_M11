<!DOCTYPE html>
<html lang="es-MX">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ciudad Futura: El Arquitecto de la Equidad</title>
<!--
  IMPLEMENTACI√ìN: Un solo archivo HTML con <style> y <script> internos, sin frameworks ni librer√≠as externas.
  Juego educativo para 3¬∞ de primaria. Lenguaje ES-MX. Desktop y tablet (mouse/touch).
  Estados: inicio ‚Üí briefing ‚Üí construccion (misi√≥n) ‚Üí resultado.
  Audio: SpeechSynthesis API (voz), WebAudio (m√∫sica/SFX). Gr√°ficos: CSS/SVG.
  C√≥digo comentado y editable por docentes.
-->
<style>
  :root{
    --bg: #e6f6ff;
    --panel: #ffffff;
    --text: #13334c;
    --accent: #00a5ff;
    --accent-2: #ffb703;
    --accent-3: #7dd957;
    --danger: #ff4d4f;
    --ok: #14b8a6;
    --grid: #bfe9ff;
    --shadow: 0 10px 20px rgba(0,0,0,.15);
    --radius: 18px;
    --focus: 0 0 0 3px rgba(0,165,255,.45);
  }
  /* Alto contraste y daltonismo (activables por toggle) */
  body.high-contrast{
    --bg:#000; --panel:#111; --text:#fff; --accent:#ffeb3b; --accent-2:#4caf50; --accent-3:#03a9f4; --grid:#333; --danger:#ff5252; --ok:#c6ff00;
  }
  body.cb-mode .pattern-a{ background-image: repeating-linear-gradient(45deg, rgba(0,0,0,.15) 0 8px, transparent 8px 16px); }
  body.cb-mode .pattern-b{ background-image: repeating-linear-gradient(90deg, rgba(0,0,0,.12) 0 10px, transparent 10px 20px); }
  body{
    margin:0; background:var(--bg); color:var(--text); font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Color Emoji", "Apple Color Emoji", sans-serif;
  }
  .app{ max-width: 1200px; margin: 0 auto; padding: 16px 16px 120px; position:relative; }
  h1,h2,h3{ margin:0 0 12px; }
  .card{ background:var(--panel); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; }
  .btn{ user-select:none; cursor:pointer; min-width: 64px; min-height:64px; display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:14px 18px; border-radius:14px; border:none; font-weight:700; font-size:1rem; color:#083344; background:linear-gradient(180deg, var(--accent), #0486cc); box-shadow:0 8px 0 #046fa8, var(--shadow); transition: transform .05s ease, filter .2s ease; }
  .btn:hover{ filter:brightness(1.05); }
  .btn:active{ transform: translateY(3px); box-shadow:0 5px 0 #046fa8, var(--shadow); }
  .btn.secondary{ background:linear-gradient(180deg, var(--accent-2), #f59e0b); box-shadow:0 8px 0 #d97706, var(--shadow); }
  .btn.ghost{ background: #ffffff; border:2px solid var(--accent); box-shadow: var(--shadow); }
  .btn.small{ min-height:48px; padding:10px 14px; border-radius:12px; font-size:.95rem; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .space{ height: 14px; }
  .scene{ display:none; }
  .scene.active{ display:block; animation:fade .35s ease; }
  @keyframes fade{ from{opacity:0; transform: translateY(6px);} to{opacity:1; transform:none;} }
  /* Barra de toggles de accesibilidad */
  .toggles{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .toggle{ display:flex; align-items:center; gap:8px; background:var(--panel); border-radius: 100px; padding: 6px 10px; box-shadow: var(--shadow); min-height:48px; }
  .switch{ position:relative; width:56px; height:30px; background:#cbd5e1; border-radius:999px; cursor:pointer; transition:background .2s; }
  .switch::after{ content:""; position:absolute; width:26px; height:26px; border-radius:50%; background:#fff; top:2px; left:2px; transition: left .2s; box-shadow:0 2px 6px rgba(0,0,0,.25); }
  .switch.on{ background: var(--accent-3); }
  .switch.on::after{ left:28px; }
  .toggle label{ font-size:.95rem; font-weight:700; }
  /* Inicio */
  .title{ font-size: clamp(28px,5vw,56px); line-height:1.05; }
  .subtitle{ opacity:.85; }
  .hero{ display:grid; grid-template-columns: 1.4fr 1fr; gap:16px; align-items:center; }
  @media (max-width: 900px){ .hero{ grid-template-columns:1fr; } }
  .city-illustration{ min-height: 260px; display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; }
  .bldg{ height:92px; border-radius: 14px; display:flex; align-items:center; justify-content:center; font-size:34px; position:relative; box-shadow:var(--shadow); }
  .bldg::after{ content:""; position:absolute; inset:0; border-radius:14px; background: repeating-linear-gradient(-45deg, rgba(255,255,255,.15) 0 10px, rgba(255,255,255,0) 10px 20px); opacity:.25; }
  .bldg.parque{ background: #8be28b; }
  .bldg.bus{ background: #ffd166; }
  .bldg.hospital{ background: #ff9aa2; }
  .bldg.biblioteca{ background: #b5c0ff; }
  .bldg.escuela{ background: #a0e1ff; }
  /* Briefing */
  .brief-grid{ display:grid; grid-template-columns: 1fr 1.2fr; gap:16px; align-items:center; }
  @media (max-width: 1000px){ .brief-grid{ grid-template-columns:1fr; } }
  .counselor{ display:flex; align-items:center; gap:12px; }
  .avatar{ width:92px; height:92px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #fff 0 40%, #ffd1dc 41%); box-shadow: var(--shadow); position:relative; }
  .avatar::before{ content:""; position:absolute; left:18px; top:46px; width:56px; height:36px; background:#ffb3c1; border-radius: 0 0 56px 56px; }
  .bubble{ background:var(--panel); border-left: 8px solid var(--accent); padding:14px 16px; border-radius: 14px; box-shadow: var(--shadow); font-size:1.15rem; font-weight:800; }
  .mini-demo{ background:var(--panel); border-radius:14px; padding:12px; box-shadow:var(--shadow); }
  .mini-city{ display:grid; grid-template-columns: repeat(6, 1fr); gap:6px; }
  .cell{ height:40px; background: #e2e8f0; border-radius:8px; position:relative; overflow:hidden; }
  .stairs, .ramp{ position:absolute; inset:8px; border-radius:6px; }
  .stairs{ background: repeating-linear-gradient( to right, #334155 0 6px, #94a3b8 6px 12px ); opacity:.9; }
  .ramp{ background: linear-gradient( 20deg, #22c55e, #86efac ); opacity:.9; clip-path: polygon(0 100%, 100% 0, 100% 100%); }
  .face{ position:absolute; right:6px; bottom:4px; font-size:18px; }
  /* Misi√≥n (Construcci√≥n) */
  .hud{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .meter{ min-width: 200px; background:var(--panel); padding:10px 12px; border-radius:14px; box-shadow: var(--shadow); }
  .meter .bar{ height:16px; background:#e2e8f0; border-radius:999px; overflow:hidden; }
  .meter .fill{ height:100%; width:50%; background: linear-gradient(90deg, var(--accent-3), var(--accent)); border-radius: 999px; transition: width .4s ease; }
  .counter{ font-weight:800; }
  .board{ display:grid; grid-template-columns: 320px 1fr; gap:12px; margin-top:12px; align-items:start; }
  @media (max-width: 1000px){ .board{ grid-template-columns:1fr; } }
  .palette{ display:grid; grid-template-columns:1fr; gap:10px; }
  .card.bcard{ display:flex; align-items:center; gap:12px; min-height:72px; cursor:pointer; border:2px solid transparent; }
  .bicon{ font-size:28px; width:42px; text-align:center; }
  .bname{ font-weight:900; font-size:1rem; }
  .bstatus{ margin-left:auto; font-weight:800; padding:6px 10px; border-radius:10px; background:#e2e8f0; }
  .bcard.locked{ opacity:.55; pointer-events:none; }
  .bcard.selected{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,165,255,.25); }
  .grid{ background: var(--panel); border-radius: 16px; padding: 10px; box-shadow: var(--shadow); }
  .grid-inner{ --cols: 8; --rows: 6; display:grid; grid-template-columns: repeat(var(--cols), 1fr); grid-template-rows: repeat(var(--rows), 72px); gap:6px; }
  .tile{ background: var(--grid); border-radius:12px; position:relative; overflow:hidden; outline:none; }
  .tile:hover{ filter:brightness(1.03); }
  .tile:focus{ box-shadow: var(--focus); }
  .cursor{ position:absolute; inset:0; border: 3px dashed var(--accent); border-radius:12px; pointer-events:none; animation:blink .65s step-end infinite; }
  @keyframes blink{ 50%{ opacity:0.35; } }
  .placed{ display:flex; align-items:center; justify-content:center; font-size:30px; }
  .placed::after{ content: attr(data-name); position:absolute; bottom:2px; left:4px; right:4px; font-size:12px; font-weight:900; background:rgba(255,255,255,.85); color:#0f172a; padding:2px 6px; border-radius:6px; text-align:center; }
  .badge-bad{ position:absolute; top:6px; right:6px; background: var(--danger); color:#fff; font-weight:900; padding:2px 6px; border-radius:999px; font-size:12px; }
  /* Puzzle Modal */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; backdrop-filter: blur(6px); }
  .modal.active{ display:flex; }
  .modal .window{ width:min(1000px, 96vw); max-height: 92vh; overflow:auto; background:var(--panel); border-radius:18px; box-shadow: var(--shadow); padding:14px; }
  .puzzle{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width: 900px){ .puzzle{ grid-template-columns:1fr; } }
  .improvements{ display:grid; grid-template-columns: 1fr; gap:10px; }
  .impr{ display:flex; align-items:center; gap:10px; padding:12px; border-radius:12px; border:2px solid #cbd5e1; cursor:pointer; }
  .impr.active{ border-color: var(--ok); background:rgba(20,184,166,.08); }
  .citizens{ display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; }
  .cit{ display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; background:#f1f5f9; }
  .cit .mood{ font-size:20px; width:28px; text-align:center; }
  .goal{ background:#f8fafc; border-radius:12px; padding:10px; border:2px dashed #cbd5e1; }
  .kbd{ background:#0ea5e9; color:#fff; font-weight:900; padding:2px 8px; border-radius:8px; font-size:.85rem; box-shadow: var(--shadow); }
  /* Resultado */
  .result{ text-align:center; }
  .trophy{ font-size: 64px; }
  .confetti{ position:fixed; inset:0; pointer-events:none; }
  /* Subt√≠tulos */
  .captions{ position:fixed; left:0; right:0; bottom:0; background:rgba(0,0,0,.75); color:#fff; padding:10px 14px; font-weight:900; letter-spacing:.2px; font-size: clamp(14px, 2vw, 20px); text-align:center; }
  .hintbar{ position:sticky; bottom:0; margin-top:12px; background:#ffffffcc; padding:10px; border-radius:12px; font-weight:800; display:flex; gap:10px; flex-wrap:wrap; align-items:center; box-shadow: var(--shadow); }
  .hintbar .h{ padding:4px 8px; border-radius:8px; background:#f1f5f9; }
  /* Accesibilidad: tama√±os t√°ctiles */
  button, .impr, .bcard, .tile{ touch-action:manipulation; min-height:64px; }
  /* Ocultos utilitarios */
  .hidden{ display:none !important; }
</style>
</head>
<body>
  <div class="app" id="app" aria-live="polite">
    <!-- ====== ESCENA: INICIO ====== -->
    <section id="inicio" class="scene active">
      <div class="hero">
        <div class="card">
          <h1 class="title">Ciudad Futura: <br>El Arquitecto de la Equidad</h1>
          <p class="subtitle">Construye una ciudad cartoon donde <b>todas</b> las personas pueden acceder. ¬°Usa la IA con equidad!</p>
          <div class="space"></div>
          <div class="row">
            <button class="btn" id="btnJugar" aria-label="Jugar">üéÆ Jugar</button>
            <button class="btn secondary" id="btnComo" aria-label="C√≥mo se juega">‚ùì C√≥mo se juega</button>
          </div>
          <div class="space"></div>
          <div class="toggles" role="group" aria-label="Preferencias de accesibilidad y audio">
            <div class="toggle" data-key="music">
              <div class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
              <label>üéµ M√∫sica</label>
            </div>
            <div class="toggle" data-key="voice">
              <div class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
              <label>üó£Ô∏è Voz</label>
            </div>
            <div class="toggle" data-key="subs">
              <div class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
              <label>üí¨ Subt√≠tulos</label>
            </div>
            <div class="toggle" data-key="contrast">
              <div class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
              <label>‚ö´ Alto Contraste</label>
            </div>
            <div class="toggle" data-key="cb">
              <div class="switch on" role="switch" aria-checked="true" tabindex="0"></div>
              <label>üé® Modo Daltonismo</label>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Tu ciudad cartoon</h3>
          <div class="city-illustration">
            <div class="bldg parque pattern-a">üèû</div>
            <div class="bldg bus pattern-b">üöå</div>
            <div class="bldg hospital">üè•</div>
            <div class="bldg biblioteca pattern-a">üìö</div>
            <div class="bldg escuela pattern-b">üè´</div>
            <div class="bldg" style="background:#c4b5fd">üå≥</div>
            <div class="bldg" style="background:#fecdd3">üè†</div>
            <div class="bldg" style="background:#fde68a">üö¶</div>
            <div class="bldg" style="background:#bbf7d0">üè°</div>
            <div class="bldg" style="background:#c7d2fe">üèôÔ∏è</div>
            <div class="bldg" style="background:#93c5fd">üöè</div>
            <div class="bldg" style="background:#a7f3d0">üåº</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ====== ESCENA: BRIEFING ====== -->
    <section id="briefing" class="scene">
      <div class="brief-grid">
        <div class="card">
          <div class="counselor">
            <div class="avatar" aria-hidden="true"></div>
            <div>
              <h2>Consejera de la Comunidad</h2>
              <div class="bubble" id="briefLine">Hola üëã</div>
            </div>
          </div>
          <div class="space"></div>
          <div class="row">
            <button class="btn" id="btnEntendido">¬°Entendido!</button>
          </div>
          <div class="space"></div>
          <div class="hintbar">
            <span class="h">Tips: poco texto, m√°s √≠conos y voz.</span>
            <span class="h">Activa/Desactiva voz y subt√≠tulos cuando gustes.</span>
          </div>
        </div>
        <div class="card mini-demo">
          <h3>Mini-demo de Accesibilidad</h3>
          <div class="mini-city" id="demoCity" aria-label="Demostraci√≥n: escaleras vs rampas">
            <!-- Se animan desde JS: primero escaleras (caras tristes), luego rampas y caras felices -->
          </div>
        </div>
      </div>
    </section>

    <!-- ====== ESCENA: MISI√ìN / CONSTRUCCI√ìN ====== -->
    <section id="mision" class="scene">
      <div class="hud">
        <div class="meter" aria-label="Medidor de Felicidad">
          <div class="row" style="justify-content:space-between"><b>üòä Felicidad</b> <span class="counter" id="felTxt">50%</span></div>
          <div class="bar"><div class="fill" id="felBar" style="width:50%"></div></div>
        </div>
        <div class="meter" aria-label="√çndice de Acceso">
          <div class="row" style="justify-content:space-between"><b>üß≠ √çndice de Acceso</b> <span class="counter" id="accTxt">50</span></div>
          <div class="bar"><div class="fill" id="accBar" style="width:50%"></div></div>
        </div>
        <div class="meter" aria-label="Ciudadanos satisfechos">
          <div class="row" style="justify-content:space-between"><b>üë®‚Äçüë©‚Äçüëß Ciudadanos Satisfechos</b> <span class="counter" id="satTxt">0</span></div>
        </div>
      </div>
      <div class="board">
        <div>
          <div class="card">
            <h3>Edificios y Servicios</h3>
            <div class="palette" id="palette"></div>
          </div>
          <div class="space"></div>
          <div class="card">
            <b>Objetivo</b>
            <p>Coloca <b>5 edificios clave</b> y termina con <b>Felicidad ‚â• 90</b>.</p>
            <div class="row"><span class="kbd">1</span> Seleccionar edificio <span class="kbd">Enter</span> Colocar <span class="kbd">R</span> Reintentar</div>
          </div>
        </div>
        <div class="grid card">
          <div class="grid-inner" id="grid" aria-label="Terreno de la ciudad en cuadr√≠cula"></div>
        </div>
      </div>
      <div class="hintbar">
        <span class="h"><span class="kbd">2</span> Abre mejoras</span>
        <span class="h"><span class="kbd">3</span> Panel de Ciudadanos</span>
        <span class="h">√Åreas t√°ctiles ‚â• 64px</span>
      </div>
    </section>

    <!-- ====== ESCENA: RESULTADO ====== -->
    <section id="resultado" class="scene">
      <div class="card result" id="resultCard">
        <!-- Se completa desde JS -->
      </div>
    </section>

    <!-- ====== MODAL: C√≥mo se juega ====== -->
    <div class="modal" id="modalComo" aria-modal="true" role="dialog" aria-label="C√≥mo se juega">
      <div class="window">
        <h2>C√≥mo se juega</h2>
        <div class="space"></div>
        <div class="row" id="slides" style="flex-wrap:nowrap; overflow:auto; scroll-snap-type:x mandatory;">
          <div class="card" style="min-width:280px; scroll-snap-align:center;">
            <div style="font-size:64px">üèóÔ∏è</div>
            <b>Coloca edificios</b>
            <p>Arrastra o toca la cuadr√≠cula.</p>
          </div>
          <div class="card" style="min-width:280px; scroll-snap-align:center;">
            <div style="font-size:64px">üó£Ô∏èüí¨</div>
            <b>Escucha a la comunidad</b>
            <p>La IA a veces olvida a alguien.</p>
          </div>
          <div class="card" style="min-width:280px; scroll-snap-align:center;">
            <div style="font-size:64px">‚ôøüß≠</div>
            <b>Agrega mejoras inclusivas</b>
            <p>¬°M√°s acceso, m√°s felicidad!</p>
          </div>
        </div>
        <div class="space"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn ghost" id="closeComo">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- ====== MODAL: Puzzle de Dise√±o Inclusivo ====== -->
    <div class="modal" id="modalPuzzle" aria-modal="true" role="dialog">
      <div class="window">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h2 id="puzzleTitle">Puzzle</h2>
          <button class="btn ghost small" id="closePuzzle">Cerrar ‚úñ</button>
        </div>
        <div class="space"></div>
        <div class="puzzle">
          <div>
            <div class="goal" id="goalBox"></div>
            <div class="space"></div>
            <div class="improvements" id="improvements"></div>
          </div>
          <div>
            <div class="card">
              <h3>Panel de Ciudadanos</h3>
              <div class="citizens" id="citizens"></div>
            </div>
            <div class="space"></div>
            <div class="row" style="justify-content:flex-end; gap:10px;">
              <button class="btn secondary" id="btnFeedback">Probar</button>
              <button class="btn" id="btnListo">Listo ‚úÖ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SUBT√çTULOS -->
    <div class="captions" id="captions">Subt√≠tulos activados</div>

    <canvas class="confetti" id="confetti" aria-hidden="true"></canvas>
  </div>

<script>
// ============================
// DATOS DEL JUEGO (EDITABLES)
// ============================
const ciudadanos = [
  {id:"nino_atleta", nombre:"Ni√±o atleta", icon:"üßíüèÉ", tags:["ninez","movilidad_ok"]},
  {id:"nino_pequeno", nombre:"Ni√±o peque√±o", icon:"üßí", tags:["ninez","pequenos"]},
  {id:"silla_ruedas", nombre:"Ni√±a en silla de ruedas", icon:"üëß‚ôø", tags:["movilidad_reducida"]},
  {id:"abuela", nombre:"Abuela", icon:"üëµ", tags:["mayores","audicion_baja"]},
  {id:"familia_migrante", nombre:"Familia migrante", icon:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶", tags:["idioma_diferente"]},
];

const edificios = [
  { id:"parque", icon:"üèû", nombre:"Parque de Juegos", baseFel:0,
    baseProblemas:["pequenos","movilidad_reducida"],
    mejoras:[
      {id:"rampa", label:"Rampa de Acceso ‚ôø", cubre:["movilidad_reducida"], fel:+8},
      {id:"columpios_bebes", label:"Columpios para Beb√©s üë∂", cubre:["pequenos"], fel:+6},
      {id:"sensoriales", label:"Juegos Sensoriales üé®", cubre:["ninez"], fel:+6}
    ], objetivoFel:20
  },
  { id:"bus", icon:"üöå", nombre:"Estaci√≥n de Autobuses", baseFel:0,
    baseProblemas:["audicion_baja","idioma_diferente"],
    mejoras:[
      {id:"texto_grande", label:"Pantallas Texto Grande üî§", cubre:["audicion_baja"], fel:+10},
      {id:"audio_multi", label:"Audio Multiling√ºe üåêüîä", cubre:["idioma_diferente"], fel:+10}
    ], objetivoFel:20
  },
  { id:"hospital", icon:"üè•", nombre:"Hospital", baseFel:0,
    baseProblemas:["movilidad_reducida","mayores"],
    mejoras:[
      {id:"rampas_todas", label:"Rampas en todas las entradas ‚ôø", cubre:["movilidad_reducida","mayores"], fel:+10},
      {id:"puertas_auto", label:"Puertas Autom√°ticas üö™‚ö°", cubre:["movilidad_reducida"], fel:+6},
      {id:"pictos", label:"Pictogramas Claros üß≠", cubre:["mayores","idioma_diferente"], fel:+6},
      {id:"botones_bajos", label:"Botones de Ascensor Bajos üîò‚¨áÔ∏è", cubre:["movilidad_reducida"], fel:+8}
    ], objetivoFel:30
  },
  // Opcionales preparados:
  { id:"biblioteca", icon:"üìö", nombre:"Biblioteca", opcional:true,
    mejoras:[
      {id:"rincon_infantil", label:"Rinc√≥n Infantil üìö", cubre:["ninez"], fel:+6},
      {id:"audiolibros", label:"Audiolibros üéß", cubre:["mayores"], fel:+6},
      {id:"bilingue", label:"Se√±al√©tica Biling√ºe üá≤üáΩüåê", cubre:["idioma_diferente"], fel:+6}
    ], objetivoFel:15
  },
  { id:"escuela", icon:"üè´", nombre:"Escuela", opcional:true,
    mejoras:[
      {id:"rampas_pasamanos", label:"Rampas y Pasamanos ‚ôø", cubre:["movilidad_reducida"], fel:+8},
      {id:"fuente_baja", label:"Fuente de Agua Baja üö∞", cubre:["ninez","movilidad_reducida"], fel:+6},
      {id:"aula_sensorial", label:"Aula Sensorial üéßüß©", cubre:["ninez"], fel:+6}
    ], objetivoFel:15
  }
];

const estado = {
  felicidad: 50,  // 0‚Äì100
  acceso: 50,
  satisfechos: 0,
  completados: 0,
  objetivoEdificios: 5,
  placed: {}, // key "r,c" -> {id, mejoras:Set, fel, completo}
  globalCovered:new Set(),
  scene: 'inicio',
  cursor: {r:0, c:0}
};

// ============================
// UTILIDADES UI / ACCESIBILIDAD
// ============================
const $ = s => document.querySelector(s);
const el = (tag, props={})=>Object.assign(document.createElement(tag), props);

const togglesState = {
  music:true, voice:true, subs:true, contrast:true, cb:true
};

function applyTogglesFromUI(){
  document.querySelectorAll('.toggle').forEach(tg=>{
    const key = tg.dataset.key; const sw = tg.querySelector('.switch');
    const on = sw.classList.contains('on'); togglesState[key]=on;
  });
  document.body.classList.toggle('high-contrast', !!togglesState.contrast);
  document.body.classList.toggle('cb-mode', !!togglesState.cb);
  if(!togglesState.subs){ captions.textContent=''; captions.classList.add('hidden'); } else { captions.classList.remove('hidden'); }
  Audio.setMusicEnabled(!!togles('music'));
}
const togles = key => togglesState[key];

// Subt√≠tulos + Voz (SpeechSynthesis)
const captions = $('#captions');
function setCaption(t){ if(togles('subs')){ captions.textContent = t; captions.classList.remove('hidden'); } }
function clearCaption(){ if(togles('subs')) captions.textContent=''; }

function speak(text, {rate=1, pitch=1, force=false}={}){
  setCaption(text);
  if(!togles('voice') && !force){ return; }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'es-MX';
  u.rate = rate; u.pitch = pitch;
  u.onend = ()=> { /* opcional limpiar */ };
  try{ window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }catch(e){ /* sin voz */ }
}

// WebAudio: m√∫sica y SFX sin archivos externos
const Audio = (function(){
  let ctx, master, musicGain, sfxGain, musicOsc, musicInterval, enabled=true;
  function ensure(){ if(!ctx){ ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = .8; master.connect(ctx.destination);
    musicGain = ctx.createGain(); musicGain.gain.value = .15; musicGain.connect(master);
    sfxGain = ctx.createGain(); sfxGain.gain.value = .6; sfxGain.connect(master);
  }}
  function setMusicEnabled(on){ enabled = on; if(!on){ stopMusic(); } else if(stateIs('construccion')){ startMusic(); } }
  function startMusic(){ ensure(); stopMusic();
    // Melod√≠a amable m√≠nima: dos osciladores en terceras, tempo depende de felicidad
    musicOsc = ctx.createOscillator(); musicOsc.type='triangle'; musicOsc.frequency.value = 220; musicOsc.connect(musicGain); musicOsc.start();
    const osc2 = ctx.createOscillator(); osc2.type='sine'; osc2.frequency.value = 330; osc2.connect(musicGain); osc2.start();
    // Modulaci√≥n de volumen seg√∫n felicidad
    musicInterval = setInterval(()=>{
      const f = estado.felicidad/100; musicGain.gain.linearRampToValueAtTime(.08 + f*.22, ctx.currentTime+0.2);
      // Peque√±o arpegio
      const base = 200 + Math.floor(f*140);
      musicOsc.frequency.linearRampToValueAtTime(base, ctx.currentTime+.2);
      osc2.frequency.linearRampToValueAtTime(base*1.5, ctx.currentTime+.2);
    }, 800);
  }
  function stopMusic(){ if(musicInterval){ clearInterval(musicInterval); musicInterval=null; } try{ musicOsc&&musicOsc.stop(); }catch(e){} musicOsc=null; }
  function sfx(type){ ensure(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(sfxGain);
    if(type==='place'){ o.type='square'; o.frequency.value=260; g.gain.setValueAtTime(.5, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.001, ctx.currentTime+.15); }
    if(type==='ok'){ o.type='sine'; o.frequency.value=740; g.gain.setValueAtTime(.7, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.001, ctx.currentTime+.2); }
    if(type==='bell'){ o.type='triangle'; o.frequency.value=880; g.gain.setValueAtTime(.6, ctx.currentTime); g.gain.exponentialRampToValueAtTime(.001, ctx.currentTime+.6); }
    o.start(); o.stop(ctx.currentTime+.7);
  }
  return { startMusic, stopMusic, sfx, setMusicEnabled };
})();

// ============================
// NAVEGACI√ìN DE ESCENAS
// ============================
function go(scene){
  document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active'));
  const id = scene==='inicio'?'inicio': scene==='briefing'?'briefing': scene==='construccion'?'mision':'resultado';
  $('#'+id).classList.add('active');
  estado.scene = scene;
  if(scene==='briefing') runBriefing();
  if(scene==='construccion'){ renderHUD(); renderPalette(); renderMap(); if(togles('music')) Audio.startMusic(); }
  if(scene!=='construccion'){ Audio.stopMusic(); }
}
const stateIs = s => estado.scene===s;

// ============================
// INICIO: toggles + modal C√≥mo se juega
// ============================
$('#btnJugar').addEventListener('click', ()=>{ go('briefing'); });
$('#btnComo').addEventListener('click', ()=> $('#modalComo').classList.add('active'));
$('#closeComo').addEventListener('click', ()=> $('#modalComo').classList.remove('active'));

// Activar toggles (por defecto encendidos)
Array.from(document.querySelectorAll('.toggle .switch')).forEach(sw=>{
  sw.addEventListener('click', ()=>{ sw.classList.toggle('on'); sw.setAttribute('aria-checked', sw.classList.contains('on')?'true':'false'); applyTogglesFromUI(); });
  sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); sw.click(); } });
});
applyTogglesFromUI();

// ============================
// BRIEFING: l√≠neas + mini demo
// ============================
const briefingLines = [
  'Acceso para todos.',
  'La IA copia patrones: si ve solo escaleras, construye escaleras.',
  'La equidad da a cada uno lo que necesita.'
];
let briefIdx=0, briefTimer=null;
function runBriefing(){
  // Construir mini-city demo
  const demo = $('#demoCity'); demo.innerHTML='';
  for(let i=0;i<12;i++){
    const c = el('div',{className:'cell'}); demo.appendChild(c);
  }
  // Paso 1: s√≥lo escaleras + caras tristes
  const cells = Array.from(demo.children);
  cells.forEach((c,i)=>{
    const s = el('div',{className:'stairs'}); c.appendChild(s);
    const face = el('div',{className:'face', textContent:i%3===0?'üòü': (i%3===1?'üòï':'üòü')}); c.appendChild(face);
  });
  // Secuencia de voz y subt√≠tulos
  briefIdx=0; nextBriefLine();
  // A los 2s, convertir algunas escaleras en rampas y caras felices
  setTimeout(()=>{
    cells.forEach((c,i)=>{
      if(i%2===0){ c.innerHTML=''; const r=el('div',{className:'ramp'}); c.appendChild(r); c.appendChild(el('div',{className:'face', textContent:'üôÇ'})); }
    });
  }, 2200);
}
function nextBriefLine(){
  const line = briefingLines[briefIdx]; $('#briefLine').textContent = line; speak(line, {rate:1});
  briefIdx = (briefIdx+1)%briefingLines.length;
  clearTimeout(briefTimer); briefTimer = setTimeout(nextBriefLine, 2800);
}
$('#btnEntendido').addEventListener('click', ()=>{ clearTimeout(briefTimer); go('construccion'); setCaption(''); });

// ============================
// MISI√ìN: HUD, PALETA, MAPA, PUZZLES
// ============================
function renderHUD(){
  $('#felTxt').textContent = Math.round(estado.felicidad)+'%';
  $('#felBar').style.width = Math.max(0,Math.min(100,estado.felicidad))+'%';
  $('#accTxt').textContent = Math.round(estado.acceso);
  $('#accBar').style.width = Math.max(0,Math.min(100,estado.acceso))+'%';
  $('#satTxt').textContent = estado.satisfechos;
}

function renderPalette(){
  const pal = $('#palette'); pal.innerHTML='';
  edificios.forEach(ed=>{
    const placed = Object.values(estado.placed).some(p=>p.id===ed.id);
    const card = el('div',{className:'card bcard pattern-a'});
    if(placed) card.classList.add('locked');
    card.innerHTML = `<div class="bicon">${ed.icon||'üèóÔ∏è'}</div>
      <div class="bname">${ed.nombre}${ed.opcional?' (Opcional)':''}</div>
      <div class="bstatus">${placed?'Hecho':'Nuevo'}</div>`;
    card.addEventListener('click', ()=>{ if(!placed){ selectBuilding(ed.id); } });
    card.dataset.edid=ed.id;
    pal.appendChild(card);
  });
}

let selectedBuilding = null;
function selectBuilding(id){ selectedBuilding=id; document.querySelectorAll('.bcard').forEach(c=>c.classList.toggle('selected', c.dataset.edid===id)); speak('Selecciona un lugar para construir.'); }

const GRID_ROWS=6, GRID_COLS=8; // 6x8 cuadricula
function renderMap(){
  const grid = $('#grid'); grid.innerHTML='';
  const gi = el('div',{className:'grid-inner'}); grid.appendChild(gi);
  gi.style.setProperty('--cols', GRID_COLS); gi.style.setProperty('--rows', GRID_ROWS);
  for(let r=0;r<GRID_ROWS;r++){
    for(let c=0;c<GRID_COLS;c++){
      const key=`${r},${c}`; const t = el('button',{className:'tile', tabIndex:0});
      // cursor virtual para teclado
      if(r===estado.cursor.r && c===estado.cursor.c){ const cur = el('div',{className:'cursor'}); t.appendChild(cur); }
      // mostrar edificio colocado
      if(estado.placed[key]){
        const info = estado.placed[key];
        const ed = edificios.find(e=>e.id===info.id);
        const cell = el('div',{className:'placed', textContent: ed.icon||'üèóÔ∏è'});
        cell.setAttribute('data-name', ed.nombre);
        t.appendChild(cell);
        if(!info.completo){ const badge=el('div',{className:'badge-bad', textContent:'¬°Falta!'}); t.appendChild(badge); }
        t.addEventListener('click', ()=> openPuzzle(info.id, key));
      } else {
        t.addEventListener('click', ()=>{ if(selectedBuilding){ placeBuilding(selectedBuilding, key); } });
      }
      t.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          if(estado.placed[key]){ openPuzzle(estado.placed[key].id, key); }
          else if(selectedBuilding){ placeBuilding(selectedBuilding, key); }
        }
      });
      gi.appendChild(t);
    }
  }
}

function placeBuilding(id, key){
  if(estado.placed[key]) return;
  const ed = edificios.find(e=>e.id===id); if(!ed) return;
  estado.placed[key] = { id:ed.id, mejoras:new Set(), fel:0, completo:false, covered:new Set() };
  Audio.sfx('place');
  speak('Edificio colocado. Abre el puzzle para mejorarlo.');
  renderMap();
  // Abrir puzzle de inmediato
  openPuzzle(ed.id, key);
}

let currentKey=null; // celda actual del puzzle abierto
function openPuzzle(edId, key){
  currentKey=key; const data = edificios.find(e=>e.id===edId); const placed = estado.placed[key];
  $('#puzzleTitle').textContent = `${data.icon||'üèóÔ∏è'} ${data.nombre} ‚Äî Dise√±o Inclusivo`;
  // Objetivo
  const goal = $('#goalBox');
  goal.innerHTML = `<b>Objetivo de Felicidad del edificio:</b> ${data.objetivoFel} puntos
  <div class="space"></div>
  <div class="row"><div class="meter" style="min-width:unset; width:100%"><div class="row" style="justify-content:space-between"><span><b>Puntos actuales</b></span><span class="counter" id="pFel">${placed.fel}</span></div><div class="bar"><div class="fill" id="pFelBar" style="width:${Math.min(100, placed.fel/data.objetivoFel*100)}%"></div></div></div></div>`;

  // Mejoras
  const cont = $('#improvements'); cont.innerHTML='';
  data.mejoras.forEach(m=>{
    const active = placed.mejoras.has(m.id);
    const it = el('div',{className:'impr'+(active?' active':''), role:'checkbox', 'aria-checked': active?'true':'false', tabIndex:0});
    it.innerHTML = `<div style="font-size:24px">‚úÖ</div><div style="font-weight:800">${m.label}</div><div class="bstatus" style="margin-left:auto">+${m.fel}</div>`;
    it.addEventListener('click', ()=> toggleMejora(data, m));
    it.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); it.click(); } });
    it.dataset.mid=m.id;
    cont.appendChild(it);
  });

  // Panel de ciudadanos
  mostrarPanelCiudadanos(data);

  $('#modalPuzzle').classList.add('active');
}
$('#closePuzzle').addEventListener('click', ()=> $('#modalPuzzle').classList.remove('active'));

function toggleMejora(edificio, mejora){
  const placed = estado.placed[currentKey]; if(!placed) return;
  if(placed.mejoras.has(mejora.id)) placed.mejoras.delete(mejora.id); else placed.mejoras.add(mejora.id);
  calcularImpacto(edificio);
  // UI: marcar activa
  document.querySelectorAll('#improvements .impr').forEach(it=>{
    const on = placed.mejoras.has(it.dataset.mid); it.classList.toggle('active', on); it.setAttribute('aria-checked', on?'true':'false');
  });
}

function calcularImpacto(edificio){
  const placed = estado.placed[currentKey];
  let fel = 0; const groups = new Set();
  edificio.mejoras.forEach(m=>{ if(placed.mejoras.has(m.id)){ fel += m.fel; m.cubre.forEach(g=>groups.add(g)); }});
  // Bonificaci√≥n por cobertura m√∫ltiple
  if(groups.size>=3) fel += 5;
  placed.fel = fel;
  placed.covered = groups;
  // Actualizar UI del puzzle
  $('#pFel').textContent = fel; $('#pFelBar').style.width = Math.min(100, fel/edificio.objetivoFel*100)+'%';
  // Feedback r√°pido
  Audio.sfx('ok'); speak('¬°Gran mejora!', {}); setCaption('M√°s acceso');
  mostrarPanelCiudadanos(edificio);
}

function mostrarPanelCiudadanos(edificio){
  const cont = $('#citizens'); cont.innerHTML='';
  const placed = estado.placed[currentKey];
  ciudadanos.forEach(ci=>{
    // Estado del ciudadano con respecto al edificio
    const afecta = (edificio.baseProblemas||[]).some(p=>ci.tags.includes(p));
    let mood='üôÇ';
    if(afecta){ // Est√° afectado si el dise√±o IA b√°sico lo excluye
      mood = 'üòü';
      // Si alguna mejora cubre su necesidad -> feliz
      const cubierto = (placed.covered||new Set());
      if(ci.tags.some(t=>cubierto.has(t))) mood='üôÇ'; else mood='üòï';
    }
    const item = el('div',{className:'cit'});
    item.innerHTML = `<div class="mood">${mood}</div><div><b>${ci.icon} ${ci.nombre}</b><br><small>${ci.tags.join(', ')}</small></div>`;
    cont.appendChild(item);
  });
}

// Bot√≥n Probar: feedback sin cerrar
$('#btnFeedback').addEventListener('click', ()=>{
  const placed = estado.placed[currentKey]; if(!placed) return;
  if(placed.fel>0){ speak('¬°Gran mejora! M√°s acceso.'); Audio.sfx('ok'); }
  else { speak('Alguien qued√≥ fuera. ¬øQu√© m√°s falta?'); setCaption('¬øQu√© m√°s falta?'); }
});

// Bot√≥n Listo: aplica cambios al global
$('#btnListo').addEventListener('click', ()=>{
  const placed = estado.placed[currentKey]; const edificio = edificios.find(e=>e.id===placed.id);
  // Evaluar completitud
  const eraCompleto = placed.completo; const ahoraCompleto = placed.fel >= (edificio.objetivoFel||0);
  placed.completo = ahoraCompleto;
  // Suma de felicidad global por mejoras aplicadas en este puzzle (delta respecto a antes)
  // Regla: cada mejora suma su fel; si edificio pasa a "completo" por primera vez: +5 global
  const deltaFel = (placed.fel - (placed.prevFel||0)) + ( !eraCompleto && ahoraCompleto ? 5 : 0 );
  placed.prevFel = placed.fel;
  actualizarFelicidad(deltaFel);
  // √çndice de Acceso crece por cantidad de grupos cubiertos
  placed.covered.forEach(g=> estado.globalCovered.add(g));
  estado.acceso = Math.min(100, 30 + estado.globalCovered.size*10);
  // Ciudadanos satisfechos (conteo aproximado):
  const satisfechosAhora = ciudadanos.filter(ci=>{
    const afecta = (edificio.baseProblemas||[]).some(p=>ci.tags.includes(p));
    if(!afecta) return false; // solo contamos quienes estaban en riesgo
    const cubierto = placed.covered; return ci.tags.some(t=>cubierto.has(t));
  }).length;
  estado.satisfechos += satisfechosAhora;

  if(!eraCompleto && ahoraCompleto){ estado.completados += 1; Audio.sfx('bell'); speak('¬°Dise√±o inclusivo listo!'); }

  $('#modalPuzzle').classList.remove('active');
  renderHUD(); renderMap();
  checkVictory();
});

function actualizarFelicidad(delta){
  estado.felicidad = Math.max(0, Math.min(100, estado.felicidad + delta));
  renderHUD();
}

function checkVictory(){
  const enoughBuildings = estado.completados >= estado.objetivoEdificios;
  if(enoughBuildings && estado.felicidad >= 90){
    go('resultado');
    showResult(true);
  } else if(enoughBuildings && estado.felicidad < 90){
    go('resultado');
    showResult(false);
  }
}

function showResult(win){
  const box = $('#resultCard'); box.innerHTML='';
  if(win){
    const h = el('div', {innerHTML:`<h2>üéâ ¬°Victoria! Ciudad Inclusiva</h2><p>¬°Con dise√±o que mira a todos, la ciudad brilla!</p>`});
    const key = el('div',{className:'trophy', textContent:'üóùÔ∏è‚ú® Llave de Oro de la Ciudad Inclusiva'});
    const sum = el('p',{innerHTML:`¬°Ciudad construida! Felicidad: <b>${Math.round(estado.felicidad)}%</b>. Puzzles resueltos: <b>${estado.completados}</b>. Grupos ayudados: <b>${estado.globalCovered.size}</b>.`});
    const back = el('div',{className:'row'});
    const btnPlay = el('button',{className:'btn', textContent:'Seguir construyendo'}); btnPlay.addEventListener('click', ()=>{ go('construccion'); });
    const btnReset = el('button',{className:'btn secondary', textContent:'Reiniciar partida'}); btnReset.addEventListener('click', resetGame);
    back.append(btnPlay, btnReset);
    box.append(h,key,sum,back);
    confettiBurst();
    speak('¬°Lo lograste! Llave de Oro de la Ciudad Inclusiva.');
  } else {
    const h = el('div', {innerHTML:`<h2>ü§î Falta un poco</h2><p>La Consejera se√±ala √°reas con √≠conos rojos. Mejora esos edificios.</p>`});
    const sum = el('p',{innerHTML:`Felicidad actual: <b>${Math.round(estado.felicidad)}%</b> (objetivo ‚â• 90). Edificios completos: <b>${estado.completados}</b>/<b>${estado.objetivoEdificios}</b>.`});
    const back = el('div',{className:'row', style:'justify-content:center'});
    const btnFix = el('button',{className:'btn', textContent:'Reintentar (mantener ciudad)'}); btnFix.addEventListener('click', ()=>{ go('construccion'); markIncomplete(); });
    back.append(btnFix);
    box.append(h,sum,back);
    speak('Alguien qued√≥ fuera. ¬øQu√© m√°s falta?'); setCaption('¬øQu√© m√°s falta?');
  }
}

function markIncomplete(){
  // Marcar con badge roja los edificios no completos
  Object.entries(estado.placed).forEach(([key,info])=>{ if(!info.completo){ /* ya se marca en renderMap con badge */ } });
  renderMap();
}

function resetGame(){
  // Reinicia manteniendo preferencias de accesibilidad
  estado.felicidad=50; estado.acceso=50; estado.satisfechos=0; estado.completados=0; estado.placed={}; estado.globalCovered=new Set();
  go('construccion');
}

// ============================
// TECLADO
// ============================
window.addEventListener('keydown', (e)=>{
  if(!stateIs('construccion')) return;
  if(e.key==='1'){ // seleccionar primer edificio disponible
    const first = edificios.find(ed=> !Object.values(estado.placed).some(p=>p.id===ed.id) );
    if(first) selectBuilding(first.id);
  }
  if(e.key==='ArrowRight'){ estado.cursor.c = Math.min(GRID_COLS-1, estado.cursor.c+1); renderMap(); }
  if(e.key==='ArrowLeft'){ estado.cursor.c = Math.max(0, estado.cursor.c-1); renderMap(); }
  if(e.key==='ArrowDown'){ estado.cursor.r = Math.min(GRID_ROWS-1, estado.cursor.r+1); renderMap(); }
  if(e.key==='ArrowUp'){ estado.cursor.r = Math.max(0, estado.cursor.r-1); renderMap(); }
  if(e.key==='Enter'){
    const k = `${estado.cursor.r},${estado.cursor.c}`;
    if(estado.placed[k]) openPuzzle(estado.placed[k].id, k); else if(selectedBuilding) placeBuilding(selectedBuilding, k);
  }
  if(e.key==='R' || e.key==='r'){ go('resultado'); showResult(false); }
});

// ============================
// CONFETTI SENCILLO CANVAS
// ============================
function confettiBurst(){
  const canvas = $('#confetti'); const ctx = canvas.getContext('2d');
  const W = canvas.width = window.innerWidth; const H = canvas.height = window.innerHeight;
  const pieces = Array.from({length: 120}, ()=>({ x:Math.random()*W, y:-20-Math.random()*H, s: 6+Math.random()*10, vy: 2+Math.random()*3, rot: Math.random()*Math.PI, vr:(Math.random()-.5)*.2 }));
  let t=0; const colors=['#00a5ff','#ffb703','#7dd957','#fb7185','#c4b5fd'];
  const id = setInterval(()=>{
    ctx.clearRect(0,0,W,H); t+=1;
    pieces.forEach(p=>{ p.y += p.vy; p.rot += p.vr; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot); ctx.fillStyle = colors[pieces.indexOf(p)%colors.length]; ctx.fillRect(-p.s/2, -p.s/2, p.s, p.s); ctx.restore(); });
    if(t>240) clearInterval(id);
  }, 16);
}

// ============================
// INICIO INMEDIATO: hablar una l√≠nea de bienvenida si voz activa
// ============================
if(togles('voice')) setTimeout(()=> speak('Bienvenida y bienvenido a Ciudad Futura. ¬°Construyamos con equidad!'), 500);
</script>
</body>
</html>
